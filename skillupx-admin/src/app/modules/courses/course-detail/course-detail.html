@if (course) {

<div class="container py-3">

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h3 class="mb-0">{{ course.title }}</h3>
      <p class="text-muted mb-1">{{ course.short_description }}</p>
      <small class="text-muted">
        Price: {{ course.price | currency: course.currency : 'symbol-narrow' }}
      </small>
    </div>

    <button mat-stroked-button color="primary" (click)="openAddLesson()">
      <mat-icon>add</mat-icon>
      Add Lesson
    </button>
  </div>

  <mat-divider></mat-divider>

  <!-- LOADING -->
  @if (loading) {
  <div class="d-flex justify-content-center my-4">
    <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
  </div>
  } @else {

  <!-- NO LESSONS -->
  @if (lessons.length === 0) {
  <div class="alert alert-light border mt-3">
    No lessons yet. Click <b>Add Lesson</b> to create the first one.
  </div>
  } @else {

  <table mat-table [dataSource]="lessons" multiTemplateDataRows class="mat-elevation-z2 w-100 mt-4">

    <!-- ID -->
    <ng-container matColumnDef="lessonId">
      <th mat-header-cell *matHeaderCellDef>#</th>
      <td mat-cell *matCellDef="let row">{{ row.id }}</td>
    </ng-container>

    <!-- Title -->
    <ng-container matColumnDef="title">
      <th mat-header-cell *matHeaderCellDef>Title</th>
      <td mat-cell *matCellDef="let row">{{ row.title }}</td>
    </ng-container>

    <!-- Duration -->
    <ng-container matColumnDef="duration">
      <th mat-header-cell *matHeaderCellDef>Duration (s)</th>
      <td mat-cell *matCellDef="let row">{{ row.duration_seconds || 0 }}</td>
    </ng-container>

    <!-- Created -->
    <ng-container matColumnDef="created">
      <th mat-header-cell *matHeaderCellDef>Created</th>
      <td mat-cell *matCellDef="let row">{{ row.created_at | date: 'short' }}</td>
    </ng-container>

    <!-- Actions -->
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef>Actions</th>
      <td mat-cell *matCellDef="let row" class="text-nowrap">

        <button mat-button color="primary" (click)="toggleLesson(row, $event)">
          <mat-icon>
            {{ row.id && expandedLessonIds.has(row.id) ? 'expand_less' : 'expand_more' }}
          </mat-icon>
          Chapters
        </button>

        <button mat-button color="primary" (click)="goToAddChapter(row, $event)">
          <mat-icon>add</mat-icon>
          Add Chapter
        </button>

        <button mat-button color="warn" (click)="deleteLesson(row, $event)">
          <mat-icon>delete</mat-icon>
          Delete
        </button>

      </td>
    </ng-container>

    <!-- EXPANDED DETAIL ROW -->
    <ng-container matColumnDef="expandedDetail">
      <td mat-cell *matCellDef="let lesson" [attr.colspan]="displayedColumns.length" class="p-0">
        @if (lesson.id && expandedLessonIds.has(lesson.id)) {

        <div class="px-3 m-3 border rounded bg-light shadow-lg">
          <table mat-table [dataSource]="selectedLessonChapters[lesson.id] || []" class="mat-elevation-z1 w-100">

            <!-- Order -->
            <ng-container matColumnDef="order">
              <th mat-header-cell *matHeaderCellDef>#</th>
              <td mat-cell *matCellDef="let ch">{{ ch.id }}</td>
            </ng-container>

            <!-- Title -->
            <ng-container matColumnDef="title">
              <th mat-header-cell *matHeaderCellDef>Title</th>
              <td mat-cell *matCellDef="let ch">{{ ch.title }}</td>
            </ng-container>

            <!-- Content Type -->
            <ng-container matColumnDef="contentType">
              <th mat-header-cell *matHeaderCellDef>Type</th>
              <td mat-cell *matCellDef="let ch">
                {{ ch.content_type || 'â€”' }}
              </td>
            </ng-container>

            <!-- Active -->
            <ng-container matColumnDef="active">
              <th mat-header-cell *matHeaderCellDef>Active?</th>
              <td mat-cell *matCellDef="let ch">
                <span class="badge" [ngClass]="ch.active ? 'bg-success' : 'bg-secondary'">
                  {{ ch.active ? 'Yes' : 'No' }}
                </span>
              </td>
            </ng-container>

            <!-- Created -->
            <ng-container matColumnDef="created">
              <th mat-header-cell *matHeaderCellDef>Created</th>
              <td mat-cell *matCellDef="let ch">
                {{ ch.created_at | date:'short' }}
              </td>
            </ng-container>

            <!-- Updated -->
            <ng-container matColumnDef="updated">
              <th mat-header-cell *matHeaderCellDef>Updated</th>
              <td mat-cell *matCellDef="let ch">
                {{ ch.updated_at | date:'short' }}
              </td>
            </ng-container>

            <!-- Test Questions -->
            <ng-container matColumnDef="testQuestions">
              <th mat-header-cell *matHeaderCellDef>Questions</th>
              <td mat-cell *matCellDef="let ch">{{ ch.test_questions }}</td>
            </ng-container>

            <!-- Actions -->
            <ng-container matColumnDef="chActions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let ch">

                <button mat-button color="primary" (click)="goToEditChapter(ch, lesson, $event)">
                  <mat-icon>edit</mat-icon>
                  Edit
                </button>

                <button mat-button color="warn" (click)="deleteChapter(ch, $event)">
                  <mat-icon>delete</mat-icon>
                  Delete
                </button>

              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="chapterColumns"></tr>
            <tr mat-row *matRowDef="let ch; columns: chapterColumns"></tr>

          </table>


          @if (!(selectedLessonChapters[lesson.id]?.length)) {
          <div class="text-muted small mt-2">
            No chapters yet for this lesson.
          </div>
          }

        </div>

        }
      </td>
    </ng-container>

    <!-- ROW DEFINITIONS -->

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>

    <tr mat-row *matRowDef="let row; columns: displayedColumns" class="lesson-row" style="cursor: pointer;"
      (click)="toggleLesson(row)"></tr>

    <tr mat-row *matRowDef="let row; columns: ['expandedDetail']; when: isExpanded" class="expanded-row"></tr>

  </table>

  } }

</div>

} @else {
<div class="container py-3">
  <div class="alert alert-danger">Course not found.</div>
</div>
}