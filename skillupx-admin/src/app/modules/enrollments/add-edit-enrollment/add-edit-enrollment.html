<div class="container py-3">
  <div class="card mx-auto" style="max-width:900px;">
    <div class="card-body">
      <h4 class="mb-3">{{ mode === 'edit' ? 'Edit Enrollment' : 'Add Enrollment' }}</h4>

      <!-- guard with `form as f` to get a local ref and avoid accidental null access -->
      <form *ngIf="form as f" [formGroup]="f" (ngSubmit)="save()">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Course</label>
            <select class="form-select" formControlName="course_id">
              <option [ngValue]="null">-- choose course --</option>
              <option *ngFor="let c of courses; trackBy: trackById" [ngValue]="c.id">{{ c.title }}</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Instructor (optional)</label>
            <select class="form-select" formControlName="instructor_id">
              <option [ngValue]="null">-- none --</option>
              <option *ngFor="let i of instructors; trackBy: trackById" [ngValue]="i.id">{{ i.name }}</option>
            </select>
          </div>

          <div class="col-12">
            <mat-form-field class="w-100" appearance="outline">
              <input
                type="text"
                matInput
                placeholder="Search student by email or phone (min 3 chars)"
                [matAutocomplete]="auto"
                formControlName="student_search"
                [disabled]="saving || loading"
              />
              <mat-autocomplete
                #auto="matAutocomplete"
                (optionSelected)="onOptionSelected($event.option.value)"
                [displayWith]="displayUser.bind(this)"
              >
                <mat-option *ngFor="let u of searchResults; trackBy: trackById" [value]="u">
                  <div class="d-flex justify-content-between">
                    <div>
                      <strong>{{ u.name }}</strong>
                      <div class="small text-muted">{{ u.email || u.phone }}</div>
                    </div>
                    <div class="small text-muted align-self-center">Select</div>
                  </div>
                </mat-option>
              </mat-autocomplete>
            </mat-form-field>

            <div *ngIf="searching" class="small text-muted mb-2">Searching...</div>
          </div>

          <div class="col-12">
            <mat-expansion-panel [(expanded)]="studentPanelOpen">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  Student details
                </mat-panel-title>
                <mat-panel-description>
                  @{{ form.get('student_id')?.value ? 'Existing student selected' : 'Create / edit student info' }}
                </mat-panel-description>
              </mat-expansion-panel-header>

              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Student name</label>
                  <input class="form-control" formControlName="student_name" />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Student email</label>
                  <input class="form-control" formControlName="student_email" />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Student phone</label>
                  <input class="form-control" formControlName="student_phone" />
                </div>

                <div class="col-12 d-flex gap-2 mt-2">
                  <button type="button" class="btn btn-outline-secondary" (click)="clearStudent()">Clear / New Student</button>
                  <button type="button" class="btn btn-outline-primary" (click)="studentPanelOpen = false">Collapse</button>
                </div>
              </div>
            </mat-expansion-panel>
          </div>

          <div class="col-md-6">
            <label class="form-label">Enrollment type</label>
            <input class="form-control" formControlName="enrollment_type" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Enrollment duration</label>
            <input class="form-control" formControlName="enrollment_duration" placeholder="e.g. 30 days, 90 days" />
          </div>
        </div>

        <div class="mt-3 d-flex gap-2">
          <button class="btn btn-primary" type="submit" [disabled]="saving">{{ saving ? 'Saving...' : (mode === 'edit' ? 'Update' : 'Save') }}</button>
          <button class="btn btn-secondary" type="button" (click)="cancel()" [disabled]="saving">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>
